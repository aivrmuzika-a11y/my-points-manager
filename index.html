<!DOCTYPE html><html lang="he"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול נקודות - ימות המשיח</title>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; max-width: 700px; margin: auto; background-color: #f4f4f4; }
        h2 { text-align: center; color: #333; }
        .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .submit-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; flex: 1; font-weight: bold; }
        .btn-check { background-color: #6c757d; }
        .btn-update { background-color: #007bff; }
        .btn-reset-selected { background-color: #ffc107; color: #212529; }
        .btn-reset-all { background-color: #dc3545; }
        .msg { margin-top: 20px; padding: 15px; border-radius: 4px; text-align: center; display: none; white-space: pre-wrap; word-break: break-all; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .update-pair { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .add-btn { background-color: #28a745; margin-top: 10px; width: auto; flex: none; }
        .remove-field { background-color: #dc3545; border-radius: 50%; width: 24px; height: 24px; padding: 0; line-height: 24px; }
    </style></head><body><div class="container">
    <h2>ניהול נקודות - ימות המשיח</h2>
    <label>TOKEN:</label>
    <input type="text" id="token" placeholder="הכנס טוקן">
    <label>נתיב קובץ:</label>
    <input type="text" id="filePath" placeholder="ivr2:/Points/points_total.ini">
    <div id="fields-container"><div class="update-pair">
            <input type="number" class="id-input" placeholder="מזהה ID">
            <input type="number" class="points-input" placeholder="נקודות לעדכון">
    </div></div>
    <button type="button" class="add-btn" onclick="addField()">+ הוסף מזהה</button>
    <div class="submit-row">
        <button onclick="handleAction('check')" class="btn-check">בדוק מצב</button>
        <button onclick="handleAction('update')" class="btn-update">עדכן נקודות</button>
        <button onclick="handleAction('reset_selected')" class="btn-reset-selected">איפוס נבחרים</button>
        <button onclick="handleAction('reset_all')" class="btn-reset-all">איפוס הכל</button>
    </div>
    <div id="messageBox" class="msg"></div></div><script>
    const PROXY_URL = "https://cors-anywhere.herokuapp.com/";
    function addField() {
        const div = document.createElement('div');
        div.className = 'update-pair';
        div.innerHTML = `<input type="number" class="id-input" placeholder="מזהה ID"><input type="number" class="points-input" placeholder="נקודות לעדכון"><button class="remove-field" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('fields-container').appendChild(div);
    }
    async function handleAction(action) {
        const token = document.getElementById('token').value;
        const path = document.getElementById('filePath').value;
        if (!token || !path) { showMsg('יש למלא טוקן ונתיב קובץ', 'error'); return; }
        showMsg('מעבד בקשה...', 'success');
        try {
            const targetUrl = `https://www.call2all.co.il/ym/api/GetTextFile?token=${token}&what=${path}`;
            let response = await fetch(PROXY_URL + targetUrl);
            const data = await response.json();
            if (data.responseStatus !== 'OK') throw new Error(data.message || 'שגיאה');
            let content = data.contents || "";
            let lines = content.split(/\r?\n/).filter(line => line.trim() !== "");
            if (action === 'check') {
                showMsg(lines.filter(l => l.includes('points_total=')).join('\n'), 'success');
            } else if (action === 'reset_all') {
                lines = lines.map(line => line.replace(/(points_total=)([-.0-9]+)/, '$10'));
                await upload(token, path, lines.join('\n'));
                showMsg("כל המזהים אופסו ל-0", 'success');
            } else {
                const ids = Array.from(document.querySelectorAll('.id-input')).map(i => i.value.trim());
                const points = Array.from(document.querySelectorAll('.points-input')).map(i => i.value.trim());
                lines = lines.map(line => {
                    let match = line.match(/^digits-(\d+)-points_total=([-.0-9]+)$/);
                    if (match && ids.indexOf(match[1]) !== -1) {
                        let newVal = (action === 'update') ? (parseFloat(match[2]) + parseFloat(points[ids.indexOf(match[1])] || 0)) : 0;
                        return `digits-${match[1]}-points_total=${newVal}`;
                    }
                    return line;
                });
                await upload(token, path, lines.join('\n'));
                showMsg("הפעולה הושלמה בהצלחה!", 'success');
            }
        } catch (err) {
            let errorText = err.message;
            if (errorText.includes("cors-anywhere") || err.message === "Failed to fetch") {
                errorText = "יש לאשר גישה זמנית לפרוקסי: היכנס לכתובת https://cors-anywhere.herokuapp.com/corsdemo ולחץ על הכפתור הלבן, ואז חזור לכאן ונסה שוב.";
            }
            showMsg('שגיאה: ' + errorText, 'error');
        }
    }
    async function upload(token, path, content) {
        const formData = new FormData();
        formData.append('token', token); formData.append('what', path); formData.append('contents', content);
        const res = await fetch(PROXY_URL + `https://www.call2all.co.il/ym/api/UploadTextFile`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.responseStatus !== 'OK') throw new Error(data.message);
    }
    function showMsg(text, type) {
        const box = document.getElementById('messageBox');
        box.innerText = text; box.className = 'msg ' + type; box.style.display = 'block';
    }</script></body></html>
